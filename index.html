<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="icon" href="./assets/favicon.ico"> -->
    <title>Event</title>
    <!-- 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap" rel="stylesheet"> 
    
    <!-- 共用樣式 -->
    <link rel="stylesheet" href="./assets/css/style.css">
  </head>
  <body>
    <div class="container">
      <!-- header -->
      <div class="header">
        <img src="./assets/images/logo.svg" alt="logo">
      </div>


      <!-- loading -->
      <main class="main" id="loadingScreen">
        <div class="loading-container">
          <span class="loading-text">LOADING...</span>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>
        </div>
      </main>
      
      <!-- content -->
      <main class="main" id="mainContent" style="display: none;">
        <div class="event-container">
          <div></div>
          <div class="event-item-1" onclick="collectEvent(1)">
            <img src="./assets/images/event-1.svg" alt="event">
          </div>
          <div></div>
          <div class="event-item-2" onclick="collectEvent(2)">
            <img src="./assets/images/event-2.svg" alt="event">
          </div>
          <div></div>
          <div class="event-item-3" onclick="collectEvent(3)">
            <img src="./assets/images/event-3.svg" alt="event">
          </div>
          <div></div>
          <div class="event-item-4" onclick="collectEvent(4)">
            <img src="./assets/images/event-4.svg" alt="event">
          </div>
          <div></div>
        </div>

        <!-- 已領取 -->
        <img class="rewarded" id="rewardedImage" src="./assets/images/rewarded.svg" alt="" style="display: none;">
      </main>

   

      <!-- footer -->
      <div class="footer" id="footer" style="display: none;">
        <div class="footer-buttons">
          <!-- 使用說明 -->
          <img class="usage-button" src="./assets/images/usage.svg" alt="event" onclick="window.location.href='usage.html'">
          
          <!-- 掃描按鈕（收集完成前顯示） -->
          <img class="scan-button" id="scanButton" src="./assets/images/scan.svg" alt="event" onclick="window.location.href='scan.html'" style="display: block;">

          <!-- 禮物按鈕（收集完成後顯示） -->
          <img class="gift-button" id="giftButton" src="./assets/images/gift.svg" alt="event" onclick="showRedeemPopup()" style="display: none;">

          <!-- 隱私權政策 -->
          <img class="privacy-button" src="./assets/images/privacy.svg" alt="event" onclick="window.location.href='privacy.html'">
        </div>
        <div class="footer-line"> </div>
      </div>
      
    </div>


      <!-- 兌換獎品彈窗 -->
      <div class="popup-overlay" id="redeemPopup">
        <div class="popup-content">
          <button class="popup-close" onclick="closePopup()">×</button>
          <h2 class="popup-title">兌換獎品</h2>
          <div class="popup-content-box">
            <p class="popup-message">恭喜集滿4個主題圖章，<br>請至服務臺出示本畫面兌換獎品</p>
            <div class="popup-notice">
              <span class="notice-label">注意</span>
              <p class="notice-text">請交由服務人員按下兌換按鈕領取精美贈品</p>
            </div>
          </div>
          <button class="popup-button" onclick="goToRedeem()">去兌換</button>
        </div>
      </div>


      <!-- 確認兌換框彈窗 -->
      <div class="popup-overlay" id="confirmPopup">
        <div class="popup-content">
          <button class="popup-close" onclick="closePopup()">×</button>
          <h2 class="popup-title">兌換獎品</h2>
          <div class="popup-content-box">
            <p class="popup-message">是否確認兌換？</p>
            <div class="popup-notice">
              <span class="notice-label">注意</span>
              <p class="notice-text">請交由服務人員按下兌換按鈕領取精美贈品</p>
            </div>
          </div>
          <div style="display: flex; gap: 12px;">
            <button class="popup-button" onclick="closePopup()" style="flex: 1;">取消</button>
            <button class="popup-button" onclick="showFinishPopup()" style="flex: 1;">去兌換</button>
          </div>
        </div>
      </div>

      <!-- 兌換完成彈窗 -->
      <div class="popup-overlay" id="finishPopup">
        <div class="popup-content">
          <button class="popup-close" onclick="closePopup()">×</button>
          <h2 class="popup-title">兌換獎品</h2>
          <div class="popup-content-box">
            <p class="popup-message">請領取獎品</p>
          </div>
           <button class="popup-button" onclick="closeFinishPopup()">OK</button>
        </div>
      </div>

       <!-- 已兌換過彈窗 -->
       <div class="popup-overlay" id="redeemedPopup">
        <div class="popup-content">
          <button class="popup-close" onclick="closePopup()">×</button>
          <h2 class="popup-title">兌換獎品</h2>
          <div class="popup-content-box">
            <p class="popup-message">每支行動裝置只能體驗一次噢</p>
          </div>
           <button class="popup-button" onclick="closeFinishPopup()">OK</button>
        </div>
      </div>

      <!-- 圖章收集彈窗 -->
      <div class="popup-overlay" id="stampCollectedPopup">
        <div class="popup-content stamp-popup">
          <h2 class="popup-title">本圖章已蒐集</h2>
          <div class="stamp-icon">
            <img id="collectedStampImage" src="" alt="collected stamp">
          </div>
          <h3 class="stamp-subtitle" id="stampSubtitle"></h3>
          <p class="stamp-message">點擊<span class="ok-highlight">【OK】</span>後，請勿關閉或跳出網頁，四關闖關完成即可兌換禮物喔！</p>
          <button class="popup-button stamp-ok-button" onclick="onStampCollected()">OK</button>
        </div>
      </div>


    <script>
      // 統一的彈窗管理系統
      class PopupManager {
        constructor() {
          this.activePopup = null;
          this.redeemed = false;
          this.init();
        }

        init() {
          // 為所有彈窗添加背景點擊關閉功能
          document.addEventListener('click', (e) => {
            if (e.target.classList.contains('popup-overlay')) {
              this.closePopup();
            }
          });

          // ESC 鍵關閉彈窗
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.activePopup) {
              this.closePopup();
            }
          });
        }

        // 顯示彈窗
        showPopup(popupId) {
          // 如果已有彈窗打開，先關閉
          if (this.activePopup) {
            this.closePopup();
          }

          const popup = document.getElementById(popupId);
          if (popup) {
            popup.style.display = 'flex';
            this.activePopup = popupId;
            
            // 防止背景滾動
            document.body.style.overflow = 'hidden';
          }
        }

        // 關閉彈窗
        closePopup() {
          if (this.activePopup) {
            const popup = document.getElementById(this.activePopup);
            if (popup) {
              popup.style.display = 'none';
            }
            this.activePopup = null;
            
            // 恢復背景滾動
            document.body.style.overflow = 'auto';
          }
        }

        // 關閉所有彈窗
        closeAllPopups() {
          const popups = document.querySelectorAll('.popup-overlay');
          popups.forEach(popup => {
            popup.style.display = 'none';
          });
          this.activePopup = null;
          document.body.style.overflow = 'auto';
        }

        // 檢查是否有彈窗打開
        hasActivePopup() {
          return this.activePopup !== null;
        }
      }

      // 創建全局彈窗管理器實例
      const popupManager = new PopupManager();

      // 統一的彈窗控制函數
      function showPopup(popupId) {
        popupManager.showPopup(popupId);
      }

      function closePopup() {
        popupManager.closePopup();
      }

      function closeAllPopups() {
        popupManager.closeAllPopups();
      }

      // 兌換獎品彈窗相關函數
      function showRedeemPopup() {
        if (popupManager.redeemed) {
          showRedeemedPopup();
        } else {
          showPopup('redeemPopup');
        }
      }

      function closeRedeemPopup() {
        closePopup();
      }

      function goToRedeem() {
        // 在這裡實作兌換邏輯
        closePopup();
        showConfirmPopup();
      }

      function showFinishPopup() {
        showPopup('finishPopup');
      }

      function closeFinishPopup() {
        closePopup();
        // 領取完成後的處理
        showRewardedDisplay();
      }

      function showRedeemedPopup() {
        showPopup('redeemedPopup');
      }

      function closeRedeemedPopup() {
        closePopup();
      }

      // 顯示已領取狀態
      function showRewardedDisplay() {
        // 顯示已領取圖片
        popupManager.redeemed = true;
        const rewardedImage = document.getElementById('rewardedImage');
        if (rewardedImage) {
          rewardedImage.style.display = 'block';
        }
      
      }

      function showConfirmPopup() {
        showPopup('confirmPopup');
      }

      // 確認彈窗的回調函數
      function onConfirm() {
        alert('用戶確認了操作');
        closePopup();
      }

      function onCancel() {
        alert('用戶取消了操作');
        closePopup();
      }

      // 圖章收集狀態管理
      let collectedStamps = []
      const totalStamps = 4;

      // 圖章文字對應關係
      const stampTitles = {
        1: '全民阻詐',
        2: '金安研習營',
        3: '打詐訓練室',
        4: '防詐電話亭'
      };

      // 圖章收集函數
      function collectEvent(eventId) {
        // 檢查是否已經兌換過
        if (popupManager.redeemed) {
          showRedeemedPopup();
          return;
        }

        // 檢查是否已經收集過這個圖章
        if (collectedStamps.includes(eventId)) {
          return;
        }
        
        // 添加到已收集列表
        collectedStamps.push(eventId);

        // 更新UI顯示
        updateEventDisplay(eventId);

        // 顯示收集成功彈窗
        showStampCollectedPopup(eventId);

        // 檢查是否集滿所有圖章
        if (collectedStamps.length >= totalStamps) {
          // 切換按鈕顯示
          switchToGiftButton();
        }
      }

      // 更新事件顯示狀態
      function updateEventDisplay(eventId) {
        const eventItem = document.querySelector(`.event-item-${eventId}`);
        if (eventItem) {
          const img = eventItem.querySelector('img');
          if (img) {
            // 切換到active狀態的圖片
            const currentSrc = img.src;
            const activeSrc = currentSrc.replace('.svg', '-active.svg');
            img.src = activeSrc;
          }
        }
      }

      // 顯示圖章收集彈窗
      function showStampCollectedPopup(eventId) {
        // 根據圖章ID設置對應的圖片
        const stampImage = document.getElementById('collectedStampImage');
        if (stampImage) {
          stampImage.src = `./assets/images/event-${eventId}-img.svg`;
        }
        
        // 根據圖章ID設置對應的文字標題
        const stampSubtitle = document.getElementById('stampSubtitle');
        if (stampSubtitle && stampTitles[eventId]) {
          stampSubtitle.textContent = stampTitles[eventId];
        }
        
        showPopup('stampCollectedPopup');
      }

      // 圖章收集彈窗的OK按鈕處理
      function onStampCollected() {
        closePopup();
        // 可以在這裡添加其他邏輯，比如音效、動畫等
      }

      // 切換到禮物按鈕
      function switchToGiftButton() {
        const scanButton = document.getElementById('scanButton');
        const giftButton = document.getElementById('giftButton');
        
        if (scanButton && giftButton) {
          scanButton.style.display = 'none';
          giftButton.style.display = 'block';
        }
      }

      // 切換到掃描按鈕
      function switchToScanButton() {
        const scanButton = document.getElementById('scanButton');
        const giftButton = document.getElementById('giftButton');
        
        if (scanButton && giftButton) {
          scanButton.style.display = 'block';
          giftButton.style.display = 'none';
        }
      }

      // 更新按鈕顯示狀態
      function updateButtonDisplay() {
        if (collectedStamps.length >= totalStamps) {
          switchToGiftButton();
        } else {
          switchToScanButton();
        }
      }

      // 檢查是否已兌換
      function checkRedeemedState() {
        // 這裡可以從 localStorage 或其他地方檢查兌換狀態
        // 目前簡化為檢查已領取圖片是否顯示
        const rewardedImage = document.getElementById('rewardedImage');
        if (rewardedImage && rewardedImage.style.display === 'block') {
          popupManager.redeemed = true;
        }
      }

      // 頁面載入時初始化
      function initializeStamps() {
        // 檢查兌換狀態
        checkRedeemedState();
        
        // 根據已收集的圖章更新UI
        collectedStamps.forEach(stampId => {
          updateEventDisplay(stampId);
        });
        
        // 更新按鈕顯示狀態
        updateButtonDisplay();
      }

      // 顯示主要內容
      function showMainContent() {
        const loadingScreen = document.getElementById('loadingScreen');
        const mainContent = document.getElementById('mainContent');
        
        if (loadingScreen && mainContent) {
          loadingScreen.style.display = 'none';
          mainContent.style.display = 'flex';
        }

        const footer = document.getElementById('footer');
        if (footer) {
          footer.style.display = 'block';
        }
      }

      // 進度條動畫控制
      function animateProgress() {
        const progressFill = document.getElementById('progressFill');
        let progress = 0;
        
        const interval = setInterval(() => {
          progress += Math.random() * 15 + 5; // 隨機增加 5-20%
          
          if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            // 添加完成動畫效果
            if (progressFill) {
              progressFill.classList.add('completed');
            }
          }
          
          // 更新進度條寬度
          if (progressFill) {
            progressFill.style.width = progress + '%';
          }
        }, 150); // 每150ms更新一次
        
        return interval;
      }

      // 頁面載入完成後初始化
      document.addEventListener('DOMContentLoaded', function() {
        // 開始進度條動畫
        const progressInterval = animateProgress();
        
        // 3秒後顯示主要內容
        setTimeout(() => {
          // 確保進度條到達100%
          const progressFill = document.getElementById('progressFill');
          const progressText = document.getElementById('progressText');
          
          if (progressFill) {
            progressFill.style.width = '100%';
          }
          if (progressText) {
            progressText.textContent = '100%';
          }
          
          // 清除進度動畫
          clearInterval(progressInterval);
          
          // 短暫延遲後切換到主要內容
          setTimeout(() => {
            showMainContent();
            initializeStamps();
          }, 300);
        }, 3000);
      });

    </script>
  </body>
</html>